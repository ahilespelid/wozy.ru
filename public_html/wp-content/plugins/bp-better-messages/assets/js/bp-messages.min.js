function BPBMurlBase64ToUint8Array(e){for(var s=(e+"=".repeat((4-e.length%4)%4)).replace(/\-/g,"+").replace(/_/g,"/"),t=window.atob(s),a=new Uint8Array(t.length),i=0;i<t.length;++i)a[i]=t.charCodeAt(i);return a}function BBPMNotice(e){jQuery.amaran({theme:"colorful",content:{bgcolor:"black",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMShowError(e){jQuery.amaran({theme:"colorful",content:{bgcolor:"#c0392b",color:"#fff",message:e},sticky:!1,closeOnClick:!0,closeButton:!0,delay:1e4,position:"bottom right"})}function BBPMOpenMiniChat(e,s){jQuery(document).trigger("bp-better-messages-open-mini-chat",[e,s])}function BBPMOpenPrivateThread(e){jQuery(document).trigger("bp-better-messages-open-private-thread",[e])}!function(e){function s(s){e(document).trigger("bp-better-messages-update-unread",s),BP_Messages.total_unread=s}function t(s){void 0!==s[0].BPemojioneArea&&s[0].BPemojioneArea.trigger("change");var t=s.val();if(0===e(s).next(".bp-emojionearea").length)return t;var a=function(s){"<p>"!==(s=s.replace(/<p><\/p>/g,"")).substring(0,3)&&(s="<p>"+s);"</p>"!==s.substring(s.length-4)&&(s+="</p>");var t=e.parseHTML(s);e.each(t,function(s,t){var a=e(this);e.each(a.find("img.emojioneemoji,img.emojione"),function(){var s=e(this);s.replaceWith(s.attr("alt"))}),a.BPBMremoveAttributes(),a.find("*").BPBMremoveAttributes()});var a="";e.each(t,function(){a+=this.outerHTML}),"<p></p>"===a&&(a="");return a=a.replace(/&amp;/g,"&")}(t);return s.val(a),a}function a(s){0===e("."+I).length&&e('<div class="'+I+'"></div>').insertBefore(s);var t=s;t.addClass("bp-messages-mobile"),t.attr("id","bp-better-messages-mobile-view-container");var a=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",a);var i=t.appendTo(e("body"));i.show();var r=0;r+=i.find(".chat-header").outerHeight(),i.find(".reply").length>0&&(r+=i.find(".reply").outerHeight());var n=a-r;i.find(".scroller").css({"max-height":"",height:n}),_(i),l(),b(),e(document).trigger("bp-better-messages-mobile-open"),U=!0}function i(){if(e.each(y,function(s,t){var a=e(t);if(a.is(".bp-messages-wrap-main")){var i=a.find("> .bp-messages-side-threads-wrapper .bp-messages-side-threads");if(i.length>0){var r=i.closest(".bp-messages-side-threads-wrapper"),n=2*i.width();n<800&&(n=800),a.width()<n?(r.addClass("threads-hidden"),i.hide()):(r.removeClass("threads-hidden"),i.show())}}}),y.hasClass("bp-messages-mobile")){var s=window.innerHeight,t=0;t+=y.find(".chat-header").outerHeight(),t+=y.find(".reply").outerHeight(),e(".scroller").css("height",s-t)}else!function(){var s=e(window).height()-50,t=e("#wpadminbar");t.length>0&&t.is(":visible")&&(s-=t.height());var a=s;s>BP_Messages.max_height&&(s=BP_Messages.max_height),s=parseInt(s),jQuery(".bp-messages-wrap .scroller").each(function(){var t=e(this),i=t.closest(".bp-messages-column"),r=t.closest(".bp-messages-wrap");if(r.hasClass("bp-better-messages-mini")){var n=BP_Messages.miniChatsHeight,o=r.find(".reply").outerHeight();n>a&&(n=a-o-10),t.css("max-height",n),t.css("height",n)}else if(r.hasClass("bp-better-messages-list")){var l=BP_Messages.miniWindowsHeight;if(l>a){l=a-10;var d=t.closest(".messages");if(d.length>0){var c=d.find(".chat-header");c.length>0&&(l-=c.outerHeight())}}t.css("max-height",l),t.css("height",l)}else if(i.length>0&&i.parent().find(".bp-messages-side-threads").is(":visible")){var m=i.outerHeight()-i.find(".reply").outerHeight();t.css("max-height",m),t.css("height",m)}else t.css("max-height",s),t.css("height",s)}),jQuery(".bp-messages-wrap.bp-better-messages-list .scroller").css("max-height",s-50),jQuery(".bp-messages-wrap.bp-better-messages-mini .scroller").css("max-height",s-50)}()}function r(e){}function n(){function t(s){function t(){if(!0===r)return!1;if(a.next(".bp-emojionearea").length>0){r=!0,i();new BPBM_MediumEditor(".bp-emojionearea-editor",{toolbar:{allowMultiParagraphSelection:!1,buttons:["bold","italic","underline","strikethrough","subscript","superscript","removeFormat"],diffLeft:0,diffTop:-10,firstButtonClass:"medium-editor-button-first",lastButtonClass:"medium-editor-button-last",relativeContainer:null,standardizeSelectionStart:!1,static:!1,align:"center",sticky:!1,updateOnEmptySelection:!0},placeholder:!1,imageDragging:!1}),e(a).html("<p></p>")}else setTimeout(t,333)}var a=e(s).BPemojioneArea({tones:!0,tonesStyle:"bullet",saveEmojisAs:"unicode",autocomplete:!1,stayFocused:!1,attributes:{dir:n}});if(void 0!==a[0]){a.closest("form").addClass("bp-emoji-enabled");var r=!1;try{a[0].BPemojioneArea.on("onLoad",function(){t()})}catch(e){}setTimeout(t,333)}}function a(s,t){void 0===t&&(t=!1);var i=e(s);if(i.hasClass("loading-more")||i.hasClass("all-loaded"))return!1;i.addClass("loading-more"),i.find(".loading-messages").show();var r=[],n=i.find(".loading-messages");i.find(".threads-list > .thread").each(function(){r.push(e(this).data("id"))});var o={action:"bp_messages_get_more_threads",loaded_threads:r,user_id:BP_Messages.displayed_user_id};i.closest(".bp-messages-wrap").hasClass("bp-better-messages-list")&&(o.user_id=BP_Messages.user_id),e.post(BP_Messages.ajaxUrl,o,function(r){e(r).insertBefore(n),i.removeClass("loading-more"),i.find(".loading-messages").hide(),""===r.trim()?i.addClass("all-loaded"):t&&Math.ceil(s.get(0).scrollHeight)<=Math.ceil(s.innerHeight())&&a(s,!0)})}P=!1,k=!1,S=!0,clearTimeout(B),"function"==typeof e.fn.mediaelementplayer&&e(".bp-messages-wrap .wp-audio-shortcode, .bp-messages-wrap .wp-video-shortcode").not(".mejs-container").filter(function(){return!e(this).parent().hasClass(".mejs-mediaelement")}).mediaelementplayer(),"1"!==BP_Messages.realtime&&s(BP_Messages.total_unread),e(document).trigger("bp-better-messages-reinit-start"),m(),g(),e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?P=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(k=!0),B=P?setTimeout(c,BP_Messages.threadRefresh):setTimeout(d,BP_Messages.siteRefresh);var n="ltr";Q&&(n="rtl");if("1"===BP_Messages.mobileEmojiEnable||!A&&!e("body").hasClass("bp-messages-mobile")){t(l=".bp-messages-wrap .reply .message textarea, .bp-messages-wrap .new-message #message-input, .bp-messages-wrap .bulk-message #message-input")}else{var l=".bp-better-messages-mini .chats .chat .reply .message textarea";t(l),e.fn.BPBMloadEmojione(123),i()}"function"==typeof e.fn.BPBMoverlayScrollbars&&(jQuery(".bp-better-messages-list .tabs-content .friends .scroller,.scroller.search, .scroller.starred").BPBMoverlayScrollbars({sizeAutoCapable:!1}),jQuery(".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs").BPBMoverlayScrollbars({sizeAutoCapable:!1,overflowBehavior:{y:"hidden"}}),jQuery(".scroller.thread").BPBMoverlayScrollbars({sizeAutoCapable:!1,callbacks:{onInitialized:function(){var s=this.getElements(),t=this.scroll().max.y,a=!1;if(v("message_id").length>0){var i=v("message_id"),r=e(s.content).find(".messages-list li[data-id='"+i+"']");r.length>0&&(a=r)}!1!==a?(jQuery(this.getElements().host).addClass("user-scrolled"),this.scroll({el:a,scroll:"ifneeded",margin:20})):jQuery(s.host).is(":visible")&&0===t?o(this,!0):this.scroll({y:"100%"})},onScroll:function(e){var s=this.scroll(),t=s.position.y;0===s.max.y?o(this,!0):jQuery(this.getElements().host).hasClass("user-scrolled")?0===t&&o(this):this.scroll({y:"100%"},0)},onContentSizeChanged:function(e){var s=this.getElements(),t=this.scroll(),a=t.max.y,i=t.position.y,r=jQuery(s.host),n=jQuery(s.content).find(".list .messages-stack:last .content .messages-list li:last").outerHeight();n<100&&(n=100),(!r.hasClass("user-scrolled")||a-i<n+50)&&this.scroll({y:"100%"},100)}}}),jQuery(".scroller.threads-list-wrapper").BPBMoverlayScrollbars({sizeAutoCapable:!1,callbacks:{onInitialized:function(){},onScroll:function(e){var s=this.getElements(),t=this.scroll(),i=t.position.y,r=t.max.y,n=jQuery(s.host);r-i<=100&&a(n)},onContentSizeChanged:function(e){}}}));var p=jQuery(".bp-messages-wrap:not(.bp-better-messages-list,.bp-better-messages-mini) .scroll-wrapper .scrollbar-inner.scroll-content.threads-list-wrapper");if(0===p.length&&(p=jQuery(".bp-messages-wrap:not(.bp-better-messages-list,.bp-better-messages-mini) .scroller.scrollbar-inner.threads-list-wrapper")),p.length>0&&(Math.ceil(p.get(0).scrollHeight),Math.ceil(p.innerHeight())),jQuery(".scrollbar-inner").on("touchstart click mousewheel DOMMouseScroll",function(){e(this).addClass("user-scrolled")}),"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").BPBMmagnificPopup({delegate:"a",type:"image"}),"1"==BP_Messages.realtime){var h=[],b=[];e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .list .messages-stack .content .messages-list li:not(.seen), .bp-messages-wrap.bp-better-messages-mini .chat.open .list .messages-stack .content .messages-list li:not(.seen)").each(function(){var s=e(this).data("id"),t=e(this).data("thread");h.push(s),b.push(t)}),M.emit("getStatuses",h,function(s){var t={};e.each(h,function(){t[this]=!0}),e.each(s,function(s){delete t[s];var a=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');if(a.removeClass("sent delivered seen"),a.hasClass("my")||a.hasClass("fast")){var i="sent";e.each(this,function(){if("seen"==i)return!1;"delivered"==this&&"seen"!=i&&(i="delivered"),"seen"==this&&(i="seen")}),a.addClass(i);var n="";switch(i){case"sent":n=BP_Messages.strings.sent;break;case"delivered":n=BP_Messages.strings.delivered;break;case"seen":n=BP_Messages.strings.seen}a.find(".status").attr("title",n),r()}else"seen"!==this.toString()&&M.emit("seen",[s])}),e.each(t,function(s){var t=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s+'"]');t.removeClass("sent delivered seen"),t.addClass("seen"),t.find(".status").attr("title",BP_Messages.strings.seen),r()})}),P&&M.emit("threadOpen",P),b=function(s){var t=[];return e.each(s,function(s,a){-1===e.inArray(a,t)&&t.push(a)}),t}(b),e.each(b,function(e,s){void 0!==s&&M.emit("threadOpen",s)}),M.emit("requestUnread")}if(i(),e(window).on("resize",function(){i()}),e(".bp-messages-wrap #send-to:not(.ready)").length>0){var u=[],f=new Taggle("send-to",{placeholder:"",tabIndex:2,hiddenInputName:"recipients[]"}),w=f.getContainer(),C=f.getInput(),j=e('input[name="to"]');j.length>0&&e(j).each(function(){var s=e(this).data("img"),t=e(this).data("label");f.add(e(this).val()),e(w).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar"><img src="'+s+'" class="avatar photo" width="50" height="50"></span><span class="bpbm-name">'+t+"</span>"),e(this).remove()}),e(C).on("blur",function(s){var t=e(w).find(".taggle_sizer").text();f.add(t)}),"0"===BP_Messages.disableUsersSearch&&(e(C).autocomplete({source:function(s,t){var a=s.term;a in u?t(u[a]):e.getJSON(BP_Messages.ajaxUrl+"?q="+a+"&limit=10&action=bp_messages_autocomplete&cookie="+function(){var e,s,t,a,i,r=document.cookie.split(";"),n={};for(e=0;e<r.length;e++)s=r[e],t=s.indexOf("="),a=jQuery.trim(unescape(s.slice(0,t))),i=unescape(s.slice(t+1)),0===a.indexOf("bp-")&&(n[a]=i);return encodeURIComponent(jQuery.param(n))}(),s,function(e,s,i){u[a]=e,t(e)})},minLength:2,appendTo:w,position:{at:"left bottom",of:w},open:function(s,t){var a=e(".bp-messages-wrap #send-to .ui-autocomplete"),i=parseInt(a.css("top"))-3;a.css("top",i)},select:function(s,t){s.preventDefault(),1===s.which&&(f.add(t.item.value),e(w).find(".taggle_sizer").text(""),e("#send-to li.taggle:last .taggle_text").html('<span class="bpbm-avatar">'+t.item.img+'</span><span class="bpbm-name">'+t.item.label+"</span>"))},response:function(s,t){e(".ui-helper-hidden-accessible").hide()}}).autocomplete("instance")._renderItem=function(s,t){return e("<li>").attr("data-value",t.value).attr("data-label",t.label).append('<span class="bpbm-avatar">'+t.img+'</span><span class="bpbm-name">'+t.label+"</span>").appendTo(s)}),e("#send-to").addClass("ready")}y.find(".bp-messages-mobile-tap").css("line-height",y.height()+"px"),e(".bp-messages-side-threads .threads-list .thread.bp-messages-active-thread").removeClass("bp-messages-active-thread"),P&&e('.bp-messages-side-threads .threads-list .thread[data-id="'+P+'"]').addClass("bp-messages-active-thread"),e(document.body).trigger("post-load"),_(y),S=!1}function o(s,t){void 0===t&&(t=!1);var a=s.getElements(),i=jQuery(a.host);if(i.hasClass("loadingAtTheMoment")||i.hasClass("allMessagesWasLoaded"))return!1;var r=i.data("id");i.find(".loading-messages").show(),i.addClass("loadingAtTheMoment");var l=i.find(".messages-stack:first-child .messages-list li:first-child"),d=l.attr("data-id");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_load_messages",thread_id:r,message_id:d},function(a){i.find(".loading-messages").hide(),""===a.trim()&&i.addClass("allMessagesWasLoaded"),e(a).prependTo(i.find(".list")),i.addClass("hasLoadedMessages"),s.scroll({el:l.closest(".messages-stack"),margin:15}),n(),i.removeClass("loadingAtTheMoment"),t&&0===s.scroll().max.y&&o(s,!0)})}function l(s){if(void 0===s&&(s=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)"),0!=e(s+" .list").length){var t=e(s+" .scroller[data-id]"),a=t.data("id");if(void 0!==T[a])return!1;var i=e(s+" .list"),r=i[0].offsetHeight;if(v("message_id").length>0){var n=v("message_id"),o=e(s+" .messages-list li[data-id='"+n+"']");o.length>0&&(r=o[0].offsetTop-o[0].offsetHeight-100)}var l=i.closest(".scroller"),d=l.hasClass("user-scrolled"),c=l[0].scrollHeight-l.scrollTop()-l.height();if(!(r<l.outerHeight())&&(!d||100>=c)){var m=t.BPBMoverlayScrollbars();void 0!==m&&(m.update(),m.scroll({y:"100%"}))}}}function d(){if(clearInterval(B),B=setTimeout(d,BP_Messages.siteRefresh),"1"!=BP_Messages.realtime&&!E){var t=f("bp-messages-last-check");E=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_check_new",last_check:t},function(t){t.threads.length>0&&e.each(t.threads,function(){k?function(s){if(s.fast||"1"==s.edit)return!1;e(".bp-messages-wrap .threads-list .empty").remove();var t=s.thread_id,a=s.html;a=a.replace('loading="lazy"',"");var i=e(".bp-messages-wrap .threads-list .thread[data-id='"+t+"']");if(i.length>0){var r=s.content_site;i.each(function(){var t=e(this),a=t.find(".info p"),i=t.closest(".threads-list");if(a.html(r),void 0!==a.attr("writing-reserved")&&a.attr("writing-reserved",r),t.attr("data-message",s.id),t.prependTo(i),"1"===BP_Messages.realtime){var n=t.find(".time-wrapper"),o=parseInt(s.timestamp);n.livestamp(new Date(1e3*o))}else"1"!==BP_Messages.realtime&&void 0!==s.html&&t.replaceWith(s.html)})}else e(a).prependTo(".bp-messages-wrap .threads-list");void 0===BP_Messages.mutedThreads[t]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&u(s.id):u(s.id));g()}(this):h(this.thread_id,this.message,this.name,this.avatar)}),s(t.total_unread),E=!1})}}function c(){if(clearInterval(B),B=setTimeout(c,BP_Messages.threadRefresh),"1"!=BP_Messages.realtime&&!O){var t=f("bp-messages-last-check"),a=e(".messages-stack:last-child .messages-list li:last-child").attr("data-time");O=!0,e.post(BP_Messages.ajaxUrl,{action:"bp_messages_thread_check_new",last_check:t,thread_id:P,last_message:a},function(t){e.each(t.messages,function(){!function(s,t){var a=!1,i=!1;void 0===t&&(t=".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list)");if(""==s.message.trim())return!1;var n="1"==s.edit;"1"!=BP_Messages.realtime||s.fast||(n?(a=!0,s.temp_id=s.id):s.temp_id&&(a=!0));var o=moment(v).format("YYYY-MM-DD HH:mm:ss").toString(),l=e(t+" .messages-stack:last-child");0===l.length&&e(t+" .empty-thread").length>0&&(i=!0);var d=e(t+' .messages-list li[data-id="'+s.id+'"]'),c="";e("body").hasClass("bp-messages-mobile")&&parseInt(s.thread_id)===parseInt(P)||ifvisible.now("active")||"1"!=BP_Messages.realtime||s.user_id===BP_Messages.user_id||(c+=" unread");s.user_id==BP_Messages.user_id&&(c+=" my");s.fast&&(c+=" fast");s.user_id==BP_Messages.user_id&&"1"==BP_Messages.realtime&&(c+=" sent");c=c.trim();var m=e(t+' .messages-list li[data-id="'+s.temp_id+'"]');n&&m.length>0&&(c=m.attr("class"));var p='<li class="'+c+'" data-thread="'+s.thread_id+'" title="'+o+'" data-time="'+s.timestamp+'" data-id="'+s.id+'"><span class="favorite"><i class="fas" aria-hidden="true"></i></span>';s.user_id==BP_Messages.user_id&&(p+='<span class="status" title="'+BP_Messages.strings.sent+'"></span>');if(p+='<span class="message-content">'+s.message+"</span></li>",a&&m.length>0)return s.message!==m.find(".message-content").html()?(m.replaceWith(p),e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+s.id+'"]').each(function(){r()})):(m.attr("data-id",s.id),m.removeClass("fast"),r()),!0;if(0===d.length&&(l.length>0||i)){1==i&&e(t+" .empty-thread").remove();var h=!0,b=new Date(1e3*l.find(".messages-list > li:last-child").attr("data-time")),f=b.getFullYear()+"-"+b.getMonth()+"-"+b.getDate()+"-"+b.getHours()+"-"+b.getMinutes(),v=new Date(1e3*s.timestamp),_=v.getFullYear()+"-"+v.getMonth()+"-"+v.getDate()+"-"+v.getHours()+"-"+v.getMinutes();if(l.attr("data-user-id")===s.user_id&&(h=!1),f!==_&&(h=!0),!1===h)l.find(".messages-list").append(p);else{var w="messages-stack";s.user_id==BP_Messages.user_id?w+=" outgoing":w+=" incoming";var B='<div class="'+w+'" data-user-id="'+s.user_id+'"><div class="pic">'+s.avatar+'</div><div class="content"><div class="info"><div class="name"><a href="'+s.link+'">'+s.name+'</a></div><div class="time" title="'+o+'" data-livestamp="'+s.timestamp+'"></div></div><ul class="messages-list"></ul></div></div>';e(t+" .list").append(B),e(t+" .messages-stack:last-child .messages-list").append(p)}e(t+" .wp-audio-shortcode, "+t+" .wp-video-shortcode").not(".mejs-container").filter(function(){return!e(this).parent().hasClass(".mejs-mediaelement")}).mediaelementplayer(),"function"==typeof e.fn.BPBMmagnificPopup&&e(".bp-messages-wrap .list .messages-stack .content .messages-list li .images").BPBMmagnificPopup({delegate:"a",type:"image"}),void 0===BP_Messages.mutedThreads[s.thread_id]&&BP_Messages.user_id!=s.user_id&&(void 0!==s.count_unread?"0"!==s.count_unread&&u(s.id):u(s.id))}g()}(this)}),e.each(t.threads,function(){h(this.thread_id,this.message,this.name,this.avatar)}),s(t.total_unread),O=!1})}}function m(){if(!store.enabled)return!1;C=store.get("bp-better-messages-open-threads")||{},!1!==P&&(C[P]=Date.now()),e.each(C,function(e){this+2e3<Date.now()&&delete C[e]}),store.set("bp-better-messages-open-threads",C)}function p(t,a){if(void 0===a){var i=jQuery(event.target);a=i.hasClass("bp-messages-wrap")?i:i.closest(".bp-messages-wrap")}if(H){if(!1===confirm(BP_Messages.strings.you_are_in_call))return!1;jQuery(document).trigger("bpbm-end-call")}if(a.hasClass("bp-messages-wrap-main"))try{window.history.pushState("","",t)}catch(e){}w(a);var r=a.height();a.css("min-height",r),e(window).off(".bp-messages");var o="?action=bp_messages_load_via_ajax";void 0!==t.split("?")[1]&&(o="?"+t.split("?")[1]+"&action=bp_messages_load_via_ajax");var l=a.find(".bp-messages-side-threads-wrapper"),d=BP_Messages.ajaxUrl+o;l.length>0&&(d+="&ignore_threads"),e(".bpbm-notice").remove(),e.ajax({method:"GET",url:d,dataType:"json",cache:!1,success:function(t){void 0!==t.total_unread&&s(t.total_unread);var i=t.html,r=(i=e(i)).find(".bp-messages-side-threads-wrapper");if(l.length>0&&r.length>0)a.find(".bp-messages-side-threads-wrapper .bp-messages-column").html(i.find(".bp-messages-side-threads-wrapper .bp-messages-column").html()),a.find(".bp-messages-side-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header").html(i.find(".bp-messages-side-threads-wrapper").closest(".bp-messages-wrap").find(".chat-header").html());else{var o=i.html();a.html(o)}a.hasClass("bp-messages-wrap-main")&&(a.attr("data-thread-id",i.attr("data-thread-id")),void 0!==t.errors&&e(t.errors.join("")).insertBefore(a)),a.is("#bp-better-messages-mini-mobile-container")&&a.attr("data-thread",i.attr("data-thread-id")),n(),a.css("min-height","")}})}function g(){e(".bp-messages-wrap img.avatar[data-user-id]").each(function(){var s=e(this).attr("data-user-id"),t=!1;if(e(this).parent().hasClass("bbpm-avatar")&&(t=e(this).parent()),!t){var a=e(this).height(),i=e(this).height(),r=e(this).css("marginTop"),n=e(this).css("marginLeft"),o=e(this).css("marginBottom"),l=e(this).css("marginRight");e(this).css({marginTop:0,marginLeft:0,marginRight:0,marginBottom:0}),e(this).wrap('<span class="avatar bbpm-avatar" data-user-id="'+s+'"></span>'),(t=e(this).parent()).css({marginTop:r,marginLeft:n,marginRight:l,marginBottom:o,width:a,height:i})}D.indexOf(s)>-1?e(t).addClass("online"):e(t).removeClass("online")})}function h(s,t,a,i){if("1"!==BP_Messages.disableOnSiteNotification&&void 0===C[s]&&void 0===BP_Messages.mutedThreads[s]&&!e("body").hasClass("bp-messages-mobile")){if(e('.bp-messages-wrap .threads-list .thread[data-id="'+s+'"]:visible').length>0)return!1;var r=i.match(/src\="([^\s]*)"\s/),n=i.match(/src\='([^\s]*)'\s/);null!=r&&(i=r[1]),null!=n&&(i=n[1]);var o=e(".amaran.thread_"+s);if(o.length>0){o.find(".icon > img").attr("src",i);var l="<b>"+a+"</b>";return l+=t,o.find(".info").html(l),!0}"1"==BP_Messages.miniMessages&&"messages"===x||e.amaran({theme:"user message thread_"+s,content:{img:i,user:a,message:t},sticky:!0,closeOnClick:!1,closeButton:!0,delay:1e4,thread_id:s,position:"bottom right",onClick:function(){if(A){var t=e("#bp-better-messages-mini-mobile-open");if(t.length>0){var a=BP_Messages.url;BP_Messages.url=BP_Messages.threadUrl+this.thread_id,t.click(),BP_Messages.url=a,e(".amaran.user.message.thread_"+s).remove()}else location.href=BP_Messages.threadUrl+this.thread_id}else{var i=location.href=BP_Messages.threadUrl+this.thread_id+"&acceptCall",r=e(".bp-messages-wrap.bp-messages-wrap-main");r.length>0?p(i,r):location.href=i}}}),void 0!==t.count_unread?"0"!==t.count_unread&&u(t.id):u(t.id)}}function b(){e("*:not(.bp-messages-hide-on-mobile)").filter(function(){return("fixed"===e(this).css("position")||"absolute"===e(this).css("position"))&&!e(this).hasClass("bp-messages-wrap")&&0===e(this).closest(".uppy").length&&0===e(this).closest(".bp-messages-wrap").length}).addClass("bp-messages-hide-on-mobile")}function u(e){if("1"!==BP_Messages.enableSound)return!1;"string"==typeof e&&"tmp_"!==e.substr(0,4)&&z.notification.play()}function f(e){for(var s=e+"=",t=document.cookie.split(";"),a=0;a<t.length;a++){for(var i=t[a];" "==i.charAt(0);)i=i.substring(1,i.length);if(0==i.indexOf(s))return i.substring(s.length,i.length)}return null}function v(e){var s="[\\?&]"+(e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"))+"=([^&#]*)",t=new RegExp(s).exec(window.location.search);return null==t?"":decodeURIComponent(t[1].replace(/\+/g," "))}function _(s){var t=s.find(".chat-header"),a=t.find("> strong"),i=t.find("> .user"),r=0;t.find("> a:visible:not(.user),> div:visible").each(function(){r+=e(this).width()});var n=r+10;a.length>0&&a.css("width","calc(100% - "+n+"px)"),i.length>0&&i.css("max-width","calc(100% - "+n+"px)")}function w(e){var s=e.find(".chat-header").height(),t=e.find(".preloader");t.show(),t.parent().hasClass("bp-messages-column")||(t.css("top",s),t.css("height","calc(100% - "+s+"px)"))}var B,P,M,k,y,C={},j={},x=!1,D=[],T={},S=!1,U=!1,Q=0!==e('html[dir="rtl"]').length,H=(window.RTCPeerConnection||window.webkitRTCPeerConnection,window.mozRTCSessionDescription||window.RTCSessionDescription,!1);ifvisible.setIdleDuration(3);BP_Messages.bpbm_color;var z={notification:new Howl({src:[BP_Messages.assets+"notification.mp3",BP_Messages.assets+"notification.ogg"]}),calling:new Howl({src:[BP_Messages.assets+"calling.mp3",BP_Messages.assets+"notification.ogg"],loop:!0})};e.fn.BPBMremoveAttributes=function(){return this.each(function(){var s=e.map(this.attributes,function(e){return e.name}),t=e(this);e.each(s,function(e,s){t.removeAttr(s)})})},e(window).on("focus",function(){ifvisible.focus()}),e(window).on("blur",function(){ifvisible.blur()});var A=!1;(/iPad|iPhone|iPod/.test(navigator.userAgent)||/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4)))&&(A=!0),"0"===BP_Messages.mobileFullScreen&&(A=!1),"1"===BP_Messages.forceMobile&&(A=!0);var I="bp-better-messages-mobile-holder";e(document).ready(function(){function r(){if(g)return!1;var s=window.innerHeight,t=0;t+=y.find(".chat-header").outerHeight(),t+=y.find(".reply").outerHeight(),e(".scroller").css({"max-height":"",height:s-t})}Q=0!==e('html[dir="rtl"]').length,y=e(".bp-messages-wrap:not(.bp-better-messages-list, #bp-better-messages-mini-mobile-open)");var o=e("#bp-better-messages-mini-mobile-container"),d=e("#bp-better-messages-mini-mobile-open");if(A||d.hide(),A){var g=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;e(document).on("touchmove",".bp-messages-wrap .chat-header,.bp-messages-wrap .reply",function(e){U&&e.preventDefault()}),e(document).on("focus blur",".bp-messages-wrap textarea, .bp-messages-wrap input",function(e){setTimeout(function(){r(),l()},300)}),e(window).resize(function(){y.hasClass("bp-messages-mobile")&&r()}),y.addClass("mobile-ready");var h,u=!1;"0"===BP_Messages.disableTapToOpen?(y.find(".bp-messages-mobile-tap").css("line-height",y.height()+"px"),y.on("touchend",".bp-messages-mobile-tap",function(e){if(1!=h&&!1===u){var s=jQuery(e.target).closest(".bp-messages-wrap");s.hasClass("bp-messages-mobile")||(e.preventDefault(),e.stopImmediatePropagation(),a(s))}}).on("touchmove",function(e){h=!0}).on("touchstart",function(e){h=!1})):y.on("touchend",function(s){if(1!=h&&!1===u){var t=jQuery(s.target).closest(".bp-messages-wrap");if(!t.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),a(t);var i=e(s.originalEvent.target).closest(".thread");i.length>0&&i.click()}}}).on("touchmove",function(e){h=!0}).on("touchstart",function(e){h=!1})}e(document).on("click",".bp-messages-wrap .mobileClose",function(s){var t=jQuery(s.target).closest(".bp-messages-wrap");if(t.hasClass("bp-messages-mobile")){s.preventDefault(),s.stopImmediatePropagation(),u=!0,e("html").removeClass("bp-messages-mobile").css("overflow","auto"),t.removeClass("bp-messages-mobile").css("min-height",""),e("body").removeClass("bp-messages-mobile").css("min-height","");var a=e(window).height()-250;if(a>BP_Messages.max_height&&(a=BP_Messages.max_height),e(".scroller").css({"max-height":a,height:""}),U=!1,t.find(".bp-messages-mobile-tap").css("line-height",t.height()+"px"),t.is(o)&&o.hide(),t.is("#bp-better-messages-mobile-view-container")){var i=t;i.removeClass("bp-messages-mobile"),i.removeAttr("id");var r=e("."+I);i.insertBefore(r),r.remove()}e(window).trigger("resize"),setTimeout(function(){u=!1},100)}}),d.on("click",function(t){t.preventDefault(),d.hasClass("loading")||(d.addClass("loading"),function(t){var a=e("#bp-better-messages-mini-mobile-container");a.addClass("bp-messages-mobile"),a.find(".bp-messages-mobile-tap").remove();var i=window.innerHeight;e("html").addClass("bp-messages-mobile").css("overflow","hidden"),e("body").addClass("bp-messages-mobile").css("min-height",i),y.addClass("bp-messages-mobile").css("min-height",i);var r=0;r+=y.find(".chat-header").outerHeight();var o=i-(r+=y.find(".reply").outerHeight());e(".scroller").css({"max-height":"",height:o}),b(),a.show().html('<div class="loading-messages" style="display: block;line-height: '+o+'px">\n<div class="bounce1"></div>\n<div class="bounce2"></div>\n<div class="bounce3"></div>\n</div>');var l="?action=bp_messages_load_via_ajax";void 0!==t.split("?")[1]&&(l="?"+t.split("?")[1]+"&action=bp_messages_load_via_ajax");var d=BP_Messages.ajaxUrl+l;e.get(d,function(t){void 0!==t.total_unread&&s(t.total_unread);var i=t.html,r=e(i).filter(".bp-messages-wrap").html();a.html(r).show(),U=!0,n(),e("#bp-better-messages-mini-mobile-open").removeClass("loading")},"json")}(BP_Messages.baseUrl))});var f=!1,v=!1;if(e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").length>0?f=e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list) .thread.scroller[data-users-json]").attr("data-id"):e(".bp-messages-wrap:not(.bp-better-messages-mini,.bp-better-messages-list,#bp-better-messages-mini-mobile-container) .threads-list").length>0&&(v=!0),A)if("1"===BP_Messages.autoFullScreen)if(f||v){e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();a(_=e(".bp-messages-wrap.mobile-ready.bp-messages-wrap-main"))}else{var _=e(".bp-messages-wrap.bp-messages-wrap-bulk.mobile-ready");_.length>0&&a(_)}else(f||v)&&e("#bp-better-messages-mini-mobile-open, #bp-better-messages-mini-mobile-container").remove();"1"===BP_Messages.blockScroll&&e(".bp-messages-wrap").on("mousewheel DOMMouseScroll",".scroll-content",function(s){var t=s.originalEvent,a=t.wheelDelta||-t.detail,i=s.currentTarget.scrollHeight-e(s.currentTarget).height();this.scrollTop+=5*(a<0?1:-1),(this.scrollTop<5||i-this.scrollTop<5)&&s.preventDefault()}),store.enabled&&(C=store.get("bp-better-messages-open-threads")||{},j=store.get("bp-better-messages-mini-chats")||{},x=store.get("bp-better-messages-mini-messages")||!1,setInterval(m,1e3)),n(),void 0===BP_Messages.socket_server&&setInterval(function(){e.post(BP_Messages.ajaxUrl,{action:"bp_messages_last_activity_refresh"})},3e5),y.on("click",".threads-list .thread:not(.blocked)",function(s){if(0===e(s.target).closest(".pic").length&&0===e(s.target).closest(".delete").length&&0===e(s.target).closest(".deleted").length){s.preventDefault();p(e(this).attr("data-href"),e(this).closest(".bp-messages-wrap"))}}),e(document).on("click",".bp-messages-wrap .threads-list .thread span.delete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=(t.parent().parent(),e(t).attr("data-id")),i=e(t).height(),r=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_thread",thread_id:a,nonce:r},function(s){if(s.result){var a=t.position().top;e(t).addClass("blocked"),e(t).find(".deleted").show().css({height:i,"line-height":i+"px",top:a+"px"})}else BBPMShowError(s.errors[0])})}),e(document).on("click",".bp-messages-wrap .threads-list .thread a.undelete",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parent().parent(),a=e(t).attr("data-id");e(t).removeClass("blocked");var i=e(this).attr("data-nonce");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_un_delete_thread",thread_id:a,nonce:i},function(s){s.result?(e(t).removeClass("blocked"),e(t).find(".deleted").hide()):BBPMShowError(s.errors[0])})}),y.on("click",".messages-list li .favorite",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).parentsUntil(".messages-list","li").attr("data-id"),a="star";e(this).hasClass("active")&&(a="unstar"),e(this).toggleClass("active"),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_favorite",message_id:t,thread_id:P,type:a},function(e){})});var B,k=!1,D="";y.on("submit",".reply > form",function(s){if(s.preventDefault(),s.stopPropagation(),ifvisible.focus(),!0!==k){var a=e(this);if(a.serialize()===D)return!1;var i=t(e(this).find('textarea[name="message"]')),r=e(this).serialize(),n=P,o=e(this).find('input[name="message_id"]').val().trim().length>0,l=e(this).parent().parent().find(".thread.scroller[data-users-json]"),d=atob(l.attr("data-users-json")),m=e.parseJSON(d);if(e(this).parent().parent().hasClass("chat open")&&(n=e(this).parent().parent().attr("data-thread")),"1"===BP_Messages.encryption){var g=l.data("secret");i=BPBMAES256.encrypt(i,g),e.each(m,function(e,s){m[e].avatar=BPBMAES256.encrypt(s.avatar,g),m[e].link=BPBMAES256.encrypt(s.link,g),m[e].name=BPBMAES256.encrypt(s.name,g)})}n&&"1"==BP_Messages.realtime&&!o?M.emit("message",n,i,m,function(s){D=r,clearInterval(B),B=setInterval(function(){D=""},3e3),e(document).trigger("bp-better-messages-message-sent"),a.find('input[name="message_id"]').val(""),r+="&tempID="+s,e.post(BP_Messages.ajaxUrl,r,function(s){if(void 0!==s.result&&(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect)){a.closest(".bp-messages-wrap").hasClass("bp-better-messages-mini")?(e('.bp-better-messages-mini .chats .chat[data-thread="'+n+'"]').remove(),openMiniChat(n,!0)):p(location.href,a.closest(".bp-messages-wrap"))}}).always(function(){k=!1})}):e.post(BP_Messages.ajaxUrl,r,function(s){void 0!==s.result&&(s.result?(c(),e(document).trigger("bp-better-messages-message-sent"),D=r,clearInterval(B),B=setInterval(function(){D=""},3e3),a.find('input[name="message_id"]').val("")):(e.each(s.errors,function(){BBPMShowError(this)}),void 0!==s.redirect&&"refresh"===s.redirect&&p(location.href,a.closest(".bp-messages-wrap"))))}).always(function(){k=!1}),e(this).find("textarea, .bp-emojionearea-editor").html("").val("")}}),y.on("click ",".bpbm-stickers-selector .bpbm-stickers-selector-sticker",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-selector"),r=a.parent().find(".reply form"),n=t.data("sticker-id"),o=t.find("img").attr("src"),l=r.find('input[name="thread_id"]').val(),d=r.find('input[name="_wpnonce"]').val();a.hide(),i(),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_send_sticker",thread_id:l,sticker_id:n,sticker_img:o,_wpnonce:d},function(e){})}),y.on("click touchstart",".reply .bpbm-stickers-btn",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".reply"),a=t.parent(),i=t.find("form").find("textarea"),r=a.find(".bpbm-stickers-selector");i.blur(),r.is(":visible")||r.show()}),y.on("click",".bpbm-stickers-selector .bpbm-stickers-close",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).closest(".bpbm-stickers-selector");t.parent().find(".reply form");t.hide()}),y.on("click",".bpbm-stickers-selector .bpbm-stickers-head .bpbm-stickers-tabs span",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-selector"),i=a.find(".bpbm-stickers-selector-sticker-container");a.find(".bpbm-stickers-tabs span").removeClass("bpbm-stickers-tabs-active"),t.addClass("bpbm-stickers-tabs-active"),i.html('<div class="loading-messages"><div class="bounce1"></div><div class="bounce2"></div><div class="bounce3"></div></div>');var r=t.data("package-id");e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_get_sticker_tab",package:r},function(e){i.html(e)})});var T;y.on("keyup change",".bpbm-stickers-selector .bpbm-stickers-search input",function(s){s.preventDefault(),s.stopPropagation();var t=e(this),a=t.closest(".bpbm-stickers-search"),i=t.closest(".bpbm-stickers-selector"),r=i.find(".bpbm-stickers-selector-sticker-list"),n=a.data("search-term"),o=t.val();n!==o&&(a.data("search-term",o),T&&T.abort(),T=e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o},function(s){r.replaceWith(s),(r=i.find(".bpbm-stickers-selector-sticker-list")).BPBMoverlayScrollbars({sizeAutoCapable:!1,callbacks:{onScroll:function(s){var t=this.scroll(),a=t.position.y;if(t.max.y-a<=10){var i=this.getElements(),r=jQuery(i.host);if(!r.hasClass("bpbm-loading-stickers")){var n=r.data("pages"),l=r.data("pages-loaded")+1;l<=n&&(r.addClass("bpbm-loading-stickers"),e.post(BP_Messages.ajaxUrl,{action:"bpbm_messages_search_stickers",search:o,page:l},function(s){r.data("pages-loaded",l),e(s).appendTo(jQuery(i.content)),r.removeClass("bpbm-loading-stickers")}))}}}}})}))}),y.on("submit",".new-message form",function(s){s.preventDefault(),s.stopPropagation();var a=jQuery(s.target).closest(".bp-messages-wrap");w(a);t(e(this).find('textarea[name="message"]'));var i=e(this),r=i.serialize();e.post(BP_Messages.ajaxUrl,r,function(s){s.result?p(BP_Messages.threadUrl+s.result,a):(i.closest(".bp-messages-wrap").find(".preloader").hide(),e.each(s.errors,function(){BBPMShowError(this)}))}).fail(function(){i.closest(".bp-messages-wrap").find(".preloader").hide()})}),y.on("click","a.ajax",function(s){s.preventDefault(),s.stopPropagation();p(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),y.on("click",".bpbm-search a.search",function(s){s.preventDefault(),s.stopPropagation(),e(this).hide(),e(".bpbm-search form").show(),e(".bpbm-search form input").trigger("focus"),A&&e(".bp-messages-wrap .chat-header .settings").hide()}),y.on("click",".bpbm-search form span.close",function(s){s.preventDefault(),s.stopPropagation(),e(".bpbm-search form").hide(),e(".bpbm-search a.search").show(),e(".bpbm-search form input").val(""),A&&e(".bp-messages-wrap .chat-header .settings").show()}),y.on("submit",".bpbm-search form",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap");p(BP_Messages.url+"?"+e(this).serialize(),t)}),!1===("1"===BP_Messages.disableEnterForTouch&&A||"1"===BP_Messages.disableEnterForDesktop&&!A)&&y.on("keydown",".reply .bp-emojionearea-editor",function(s){s.shiftKey||13!=s.keyCode||(s.preventDefault(),s.stopImmediatePropagation(),e(this).trigger("blur"),e(this).parent().parent().trigger("submit"),e(this).trigger("focus"))}),y.on("change",".new-message .send-to-input",function(s){s.preventDefault(),s.stopPropagation();p(e(this).attr("href"),e(this).closest(".bp-messages-wrap"))}),A?y.on("touchend",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){if(1!=h&&!1===u){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");p(BP_Messages.threadUrl+t+"&message_id="+a,e(this).closest(".bp-messages-wrap"))}}).on("touchmove",function(e){h=!0}).on("touchstart",function(e){h=!1}):y.on("click",".scroller.starred .messages-list li, .scroller.search .messages-list li",function(s){s.preventDefault(),s.stopPropagation();var t=e(this).attr("data-thread"),a=e(this).attr("data-id");p(BP_Messages.threadUrl+t+"&message_id="+a,e(this).closest(".bp-messages-wrap"))}),y.on("click",".participants-panel .bp-messages-user-list .user .actions a.remove-from-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).parent().parent(),i=a.data("id"),r=a.data("thread-id"),n=a.find(".name").text(),o=BP_Messages.strings.exclude;o=o.replace("%s",n);confirm(o)&&e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_exclude_user_from_thread",user_id:i,thread_id:r},function(s){if(!0===s.result){p(BP_Messages.url+"?"+e.param({thread_id:r,participants:"1"}),t)}})}),y.on("click",".chat-header .bpbm-mute-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=parseInt(t.attr("data-thread-id")),i=location.href;t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),i=BP_Messages.baseUrl+"?thread_id="+a);confirm(BP_Messages.strings.mute_thread)&&(w(t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_mute_thread",thread_id:a},function(s){p(i,t);e('.bp-messages-wrap .threads-list .thread[data-id="'+a+'"] .bpbm-counter-row').prepend('<span class="bpbm-thread-muted"><i class="fas fa-bell-slash"></i></span>'),BP_Messages.mutedThreads[a]=Date.now()}).always(function(){}))}),y.on("click",".chat-header .bpbm-leave-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=parseInt(t.attr("data-thread-id")),i=location.href;t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),i=BP_Messages.baseUrl+"?thread_id="+a);confirm(BP_Messages.strings.leave_thread)&&(w(t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_leave_thread",thread_id:a},function(e){p(i,t)}))}),y.on("click",".chat-header .bpbm-unmute-thread",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=parseInt(t.attr("data-thread-id")),i=location.href;t.is("#bp-better-messages-mini-mobile-container")&&(a=t.attr("data-thread"),i=BP_Messages.baseUrl+"?thread_id="+a);confirm(BP_Messages.strings.unmute_thread)&&(w(t),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_unmute_thread",thread_id:a},function(s){void 0!==BP_Messages.mutedThreads[a]&&delete BP_Messages.mutedThreads[a],e('.bp-messages-wrap .threads-list .thread[data-id="'+a+'"] .bpbm-counter-row .bpbm-thread-muted').remove(),p(i,t)}).always(function(){}))}),y.on("click",".participants-panel .add-user button",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).parent(),i=a.data("thread-id"),r=[];a.find('input[name="recipients[]"]').each(function(){r.push(e(this).val())}),e.post(BP_Messages.ajaxUrl,{action:"bp_better_messages_add_user_to_thread",users:r,thread_id:i},function(s){p(BP_Messages.url+"?"+e.param({thread_id:i,participants:"1"}),t)})}),"1"===BP_Messages.allowDeleteMessages&&y.on("click",".list .messages-stack.outgoing .content .messages-list li",function(s){(e(s.target).hasClass("message-content")||e(s.target).is("li")||e(s.target).hasClass("images"))&&!e(this).closest(".bp-messages-wrap").hasClass("bp-better-messages-mini")&&function(s,t){void 0===t?e(s).toggleClass("selected"):!0===t?e(s).addClass("selected"):e(s).removeClass("selected");var a=e(s).closest(".bp-messages-wrap"),i=a.find(".chat-controls"),r=a.find(".messages-stack li.selected").length;if(r>0){i.show();var n=!0,o=!0;a.find(".messages-stack.incoming li.selected").length>0&&(n=!1,o=!1),r>1&&(n=!1),n?i.find(".bpbm-edit").show():i.find(".bpbm-edit").hide(),o?i.find(".bpbm-delete").show():i.find(".bpbm-delete").hide()}else i.hide()}(this)}),y.on("click",".chat-controls a.bpbm-edit",function(s){s.preventDefault();var t=e(this).closest(".bp-messages-wrap"),a=e(this).data("wp-nonce"),i=t.find(".messages-stack li.selected").data("id");e.post(BP_Messages.ajaxUrl,{action:"bp_messages_get_edit_message",message_id:i,_wpnonce:a},function(e){t.find('.reply form input[name="message_id"]').val(i),t.find(".bp-emojionearea-editor").html(e)})}),y.on("click",".chat-controls a.bpbm-delete",function(s){s.preventDefault();var t=e(this).data("wp-nonce"),a=BP_Messages.strings.confirm_delete,i=e(this).closest(".bp-messages-wrap"),r=i.find(".messages-stack li.selected");a=a.replace("%s",r.length);if(confirm(a)){var n=[];e.each(r,function(){n.push(e(this).data("id"))}),e.post(BP_Messages.ajaxUrl,{action:"bp_messages_delete_message",thread_id:P,messages_ids:n,_wpnonce:t},function(s){s.result?(BBPMNotice(s.message),function(s){e.each(s,function(){var s=e('.bp-messages-wrap .list .messages-stack .content .messages-list li[data-id="'+this+'"]'),t=s.closest(".messages-stack");s.remove(),0===t.find(".messages-list > li").length&&t.remove(),e('.bp-messages-wrap .threads-list .thread[data-message="'+this+'"] .info p').text("...")})}(n)):BBPMShowError(s.errors[0]),i.find(".chat-controls").hide()})}}),e(document).on("click",".bp-better-messages-list .tabs > div",function(s){s.preventDefault();var t=e(this).data("tab");e(this).hasClass("active")?(e(this).removeClass("active"),e(".bp-better-messages-list .tabs-content ."+t).removeClass("active"),x=!1):(e(".bp-better-messages-list .tabs > div, .bp-better-messages-list .tabs-content > div").removeClass("active"),e(this).addClass("active"),e(".bp-better-messages-list .tabs-content ."+t).addClass("active"),x=t),store.set("bp-better-messages-mini-messages",x)}),e(document).on("click",".bpbm-deleted-user-link",function(e){e.preventDefault()}),e(document).on("click",".bp-better-messages-list .new-message",function(s){var t=e(".bp-messages-wrap.bp-messages-wrap-main");t.length>0&&(s.preventDefault(),p(e(this).attr("href"),t))}),e(document).on("click",".bp-better-messages-list .bp-messages-user-list .user:not(.blocked)",function(s){if(e(s.target).is("div")){s.preventDefault();var t=e(this),a=e(this).data("id"),i=e(this).data("username");if("1"==BP_Messages.miniChats&&"1"==BP_Messages.fastStart){var r=t.parent().parent(),n=e(t).height(),o=t.position().top;o+=r.scrollTop(),e(t).find(".loading").css({height:n,"line-height":n+"px",top:o+"px"}),t.addClass("blocked loading"),openPrivateThread(a).always(function(e){t.removeClass("blocked loading")})}else{var l=BP_Messages.url+"?new-message&to="+i;"1"==BP_Messages.fastStart&&(l+="&fast=1&scrollToContainer");var d=e(".bp-messages-wrap.bp-messages-wrap-main");d.length>0?p(l,d):location.href=l}}})}),jQuery(document).on("bp-better-messages-update-unread",function(e,s){var t=jQuery(".bp-better-messages-unread");if(s=parseInt(s),(isNaN(s)||s<0)&&(s=0),t.each(function(){var e=jQuery(this),t=e.hasClass("bpbmuc");e.text(s),t?e.attr("data-count",s):0===s?e.addClass("no-count"):e.removeClass("no-count")}),jQuery("body").hasClass("my-account")){var a=jQuery("#user-bp_better_messages_tab");if(a.length>0){var i=a.find("span.count");s>0?i.length>0?i.text(s):jQuery('<span class="count">'+s+"</span>").appendTo(a):i.remove()}}});var E=!1,O=!1}(jQuery);